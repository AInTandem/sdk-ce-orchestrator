name: Handle API Changes from Orchestrator

on:
  repository_dispatch:
    types: [api_changes]

permissions:
  issues: write

jobs:
  create-issue:
    name: Create API Change Issue
    runs-on: ubuntu-latest
    steps:
      - name: Create/Update Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { release_tag, previous_tag, breaking_count, release_url, changelog } = context.payload.client_payload;

            const title = 'API Changes from Orchestrator';
            const body = `## API Changes from Orchestrator

            **Release**: \`${release_tag}\`
            **Previous**: \`${previous_tag || 'none'}\`
            **Breaking Changes**: ${breaking_count}
            **Date**: ${new Date().toISOString()}
            **View**: [${release_tag}](${release_url})

            ---

            ${changelog}

            ---

            ### Next Steps
            1. Review the changes above
            2. Update generated types: \`pnpm generate-types\`
            3. Run tests: \`pnpm test\`
            4. Create PR for type updates

            ðŸ”— [Full OpenAPI Spec](https://aintandem.github.io/orchestrator-api/)
            `;

            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              creator: 'github-actions[bot]'
            });

            const existingIssue = issues.find(i => i.title.includes(title));

            if (existingIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### New Release Detected - ${release_tag}\n\n${body}`
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['api-changes', 'automated']
              });

              console.log(`Created new issue #${newIssue.number}`);
            }
