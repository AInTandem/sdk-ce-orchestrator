#!/bin/sh
set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

printf "üöÄ Running pre-push checks...\n"

# 0. Check for workspace dependencies in react package
printf "${YELLOW}‚ñ∂ Checking npm dependencies...${NC}\n"
if grep -q "workspace:\*" packages/react/package.json; then
    printf "\n"
    printf "${RED}‚ùå workspace:* found in packages/react/package.json!${NC}\n"
    printf "${YELLOW}Please use version ranges (e.g., ^0.5.1) instead of workspace:*${NC}\n"
    exit 1
fi
printf "${GREEN}‚úì Npm dependencies check passed${NC}\n"

# 1. TypeScript type check
printf "${YELLOW}‚ñ∂ TypeScript type check...${NC}\n"
if ! pnpm typecheck; then
    printf "\n"
    printf "${RED}‚ùå Type check failed!${NC}\n"
    exit 1
fi
printf "${GREEN}‚úì Type check passed${NC}\n"

# 2. ESLint
printf "${YELLOW}‚ñ∂ ESLint...${NC}\n"
if ! pnpm lint; then
    printf "\n"
    printf "${RED}‚ùå Linting failed!${NC}\n"
    exit 1
fi
printf "${GREEN}‚úì Linting passed${NC}\n"

# 3. Build
printf "${YELLOW}‚ñ∂ Building...${NC}\n"
if ! pnpm build > /dev/null 2>&1; then
    printf "\n"
    printf "${RED}‚ùå Build failed!${NC}\n"
    exit 1
fi
printf "${GREEN}‚úì Build passed${NC}\n"

# 4. Unit tests (skip if SKIP_TESTS=true)
if [ "$SKIP_TESTS" != "true" ]; then
    printf "${YELLOW}‚ñ∂ Unit tests...${NC}\n"
    if ! pnpm test 2>&1; then
        printf "\n"
        printf "${YELLOW}‚ö†Ô∏è  Unit tests failed or not configured, skipping...${NC}\n"
        printf "To skip: SKIP_TESTS=true git push\n"
    fi
    printf "${GREEN}‚úì Unit tests passed${NC}\n"
else
    printf "${YELLOW}‚è≠Ô∏è  Skipping unit tests (SKIP_TESTS=true)${NC}\n"
fi

# 5. E2E tests (skip if SKIP_E2E=true)
if [ "$SKIP_E2E" != "true" ]; then
    printf "${YELLOW}‚ñ∂ E2E tests...${NC}\n"
    if ! pnpm test:e2e 2>/dev/null; then
        printf "\n"
        printf "${YELLOW}‚ö†Ô∏è  No E2E tests configured, skipping...${NC}\n"
    fi
    printf "${GREEN}‚úì E2E tests passed${NC}\n"
else
    printf "${YELLOW}‚è≠Ô∏è  Skipping E2E tests (SKIP_E2E=true)${NC}\n"
fi

printf "\n"
printf "${GREEN}‚úÖ All pre-push checks passed!${NC}\n"
exit 0
